//LOGIN NUEVO MEJORADO PERO FALTA
// views/login_screen.dart - MEJORADO
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../viewmodels/auth_viewmodel.dart';
import '../../utils/constants.dart';

class LoginScreen extends StatefulWidget {
  const LoginScreen({super.key});

  @override
  State<LoginScreen> createState() => _LoginScreenState();
}

class _LoginScreenState extends State<LoginScreen> 
    with SingleTickerProviderStateMixin {
  final _emailController = TextEditingController();
  final _passwordController = TextEditingController();
  bool _obscurePassword = true;

  late AnimationController _animationController;
  late Animation<double> _fadeAnimation;
  late Animation<Offset> _slideAnimation;

  @override
  void initState() {
    super.initState();
    _animationController = AnimationController(
      duration: AppDurations.medium,
      vsync: this,
    );

    _fadeAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeInOut),
    );

    _slideAnimation = Tween<Offset>(
      begin: const Offset(0, 0.3), 
      end: Offset.zero
    ).animate(
      CurvedAnimation(parent: _animationController, curve: Curves.easeOut),
    );

    _animationController.forward();
  }

  @override
  void dispose() {
    _animationController.dispose();
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final authViewModel = Provider.of<AuthViewModel>(context);

    return Scaffold(
      backgroundColor: AppColors.background,
      body: SafeArea(
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(AppSpacing.large),
          child: FadeTransition(
            opacity: _fadeAnimation,
            child: SlideTransition(
              position: _slideAnimation,
              child: Column(
                children: [
                  _buildHeader(),
                  const SizedBox(height: AppSpacing.xlarge),
                  _buildLoginCard(authViewModel),
                  const SizedBox(height: AppSpacing.xlarge),
                  _buildFooter(),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildHeader() {
    return Column(
      children: [
        Container(
          width: 120,
          height: 120,
          decoration: BoxDecoration(
            gradient: const LinearGradient(
              colors: [AppColors.primary, AppColors.secondary],
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
            ),
            borderRadius: BorderRadius.circular(AppRadius.large),
            boxShadow: [
              BoxShadow(
                color: AppColors.primary.withOpacity(0.3),
                blurRadius: 15,
                offset: const Offset(0, 4),
              ),
            ],
          ),
          child: const Icon(
            Icons.school_rounded,
            size: 60,
            color: Colors.white,
          ),
        ),
        const SizedBox(height: AppSpacing.medium),
        Text(
          AppStrings.appName,
          style: AppTextStyles.heading1.copyWith(
            fontSize: 32,
            fontWeight: FontWeight.w900,
            color: AppColors.primary,
          ),
        ),
        const SizedBox(height: AppSpacing.small),
        Text(
          'Sistema de Gestión Académica',
          style: AppTextStyles.body.copyWith(
            color: AppColors.textSecondary,
            fontSize: 14,
          ),
          textAlign: TextAlign.center,
        ),
      ],
    );
  }

  Widget _buildLoginCard(AuthViewModel authViewModel) {
    return Container(
      padding: const EdgeInsets.all(AppSpacing.large),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(AppRadius.medium),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withOpacity(0.1),
            blurRadius: 20,
            offset: const Offset(0, 10),
          ),
        ],
        border: Border.all(color: AppColors.border.withOpacity(0.5)),
      ),
      child: Column(
        children: [
          Text(
            'Inicio de Sesión',
            style: AppTextStyles.heading2.copyWith(
              color: AppColors.primary,
              fontSize: 24,
            ),
          ),
          const SizedBox(height: AppSpacing.small),
          Text(
            'Ingresa con tus credenciales',
            style: AppTextStyles.body.copyWith(color: AppColors.textSecondary),
          ),
          const SizedBox(height: AppSpacing.large),

          _buildEmailField(),
          const SizedBox(height: AppSpacing.medium),

          _buildPasswordField(),
          const SizedBox(height: AppSpacing.medium),

          if (authViewModel.error != null) _buildErrorWidget(authViewModel.error!),
          const SizedBox(height: AppSpacing.medium),

          _buildLoginButton(authViewModel),
          const SizedBox(height: AppSpacing.medium),

          _buildForgotPassword(),
        ],
      ),
    );
  }

  Widget _buildEmailField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Correo Institucional',
          style: AppTextStyles.heading3.copyWith(color: AppColors.textPrimary),
        ),
        const SizedBox(height: AppSpacing.small),
        Container(
          decoration: BoxDecoration(
            color: AppColors.background,
            borderRadius: BorderRadius.circular(AppRadius.small),
            border: Border.all(color: AppColors.border),
          ),
          child: TextField(
            controller: _emailController,
            keyboardType: TextInputType.emailAddress,
            style: AppTextStyles.body,
            decoration: const InputDecoration(
              prefixIcon: Icon(Icons.email_rounded, color: AppColors.primary),
              hintText: 'usuario@incos.edu.bo',
              border: InputBorder.none,
              contentPadding: EdgeInsets.symmetric(
                horizontal: AppSpacing.medium,
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildPasswordField() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Contraseña',
          style: AppTextStyles.heading3.copyWith(color: AppColors.textPrimary),
        ),
        const SizedBox(height: AppSpacing.small),
        Container(
          decoration: BoxDecoration(
            color: AppColors.background,
            borderRadius: BorderRadius.circular(AppRadius.small),
            border: Border.all(color: AppColors.border),
          ),
          child: TextField(
            controller: _passwordController,
            obscureText: _obscurePassword,
            style: AppTextStyles.body,
            decoration: InputDecoration(
              prefixIcon: const Icon(Icons.lock_rounded, color: AppColors.primary),
              suffixIcon: IconButton(
                icon: Icon(
                  _obscurePassword ? Icons.visibility_rounded : Icons.visibility_off_rounded,
                  color: AppColors.textSecondary,
                ),
                onPressed: () {
                  setState(() {
                    _obscurePassword = !_obscurePassword;
                  });
                },
              ),
              hintText: 'Ingresa tu contraseña',
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: AppSpacing.medium,
              ),
            ),
          ),
        ),
      ],
    );
  }

  Widget _buildErrorWidget(String error) {
    return Container(
      width: double.infinity,
      padding: const EdgeInsets.all(AppSpacing.medium),
      decoration: BoxDecoration(
        color: AppColors.error.withOpacity(0.1),
        borderRadius: BorderRadius.circular(AppRadius.small),
        border: Border.all(color: AppColors.error.withOpacity(0.3)),
      ),
      child: Row(
        children: [
          Icon(Icons.error_outline_rounded, color: AppColors.error, size: 20),
          const SizedBox(width: AppSpacing.small),
          Expanded(
            child: Text(
              error,
              style: AppTextStyles.body.copyWith(color: AppColors.error),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLoginButton(AuthViewModel authViewModel) {
    return SizedBox(
      width: double.infinity,
      child: AnimatedContainer(
        duration: AppDurations.short,
        decoration: BoxDecoration(
          gradient: authViewModel.isLoading
              ? null
              : const LinearGradient(
                  colors: [AppColors.primary, AppColors.secondary],
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                ),
          borderRadius: BorderRadius.circular(AppRadius.small),
          boxShadow: authViewModel.isLoading
              ? []
              : [
                  BoxShadow(
                    color: AppColors.primary.withOpacity(0.3),
                    blurRadius: 10,
                    offset: const Offset(0, 4),
                  ),
                ],
        ),
        child: Material(
          color: authViewModel.isLoading ? AppColors.textSecondary : Colors.transparent,
          borderRadius: BorderRadius.circular(AppRadius.small),
          child: InkWell(
            onTap: authViewModel.isLoading ? null : () => _login(authViewModel),
            borderRadius: BorderRadius.circular(AppRadius.small),
            child: Container(
              padding: const EdgeInsets.symmetric(vertical: 16),
              child: Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  if (authViewModel.isLoading)
                    SizedBox(
                      width: 20,
                      height: 20,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  else
                    const Icon(Icons.login_rounded, color: Colors.white, size: 20),
                  const SizedBox(width: AppSpacing.small),
                  Text(
                    authViewModel.isLoading ? 'Verificando...' : 'Iniciar Sesión',
                    style: AppTextStyles.button.copyWith(
                      fontSize: 16,
                      fontWeight: FontWeight.w700,
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildForgotPassword() {
    return TextButton(
      onPressed: () {
        _showForgotPasswordDialog();
      },
      child: Text(
        '¿Olvidaste tu contraseña?',
        style: AppTextStyles.body.copyWith(
          color: AppColors.primary,
          decoration: TextDecoration.underline,
        ),
      ),
    );
  }

  Widget _buildFooter() {
    return Column(
      children: [
        Text(
          'Sistema Seguro - INCOS El Alto',
          style: AppTextStyles.body.copyWith(
            color: AppColors.textSecondary,
            fontSize: 12,
          ),
        ),
        const SizedBox(height: AppSpacing.small),
        Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Container(
              width: 8,
              height: 8,
              decoration: const BoxDecoration(
                color: AppColors.success,
                shape: BoxShape.circle,
              ),
            ),
            const SizedBox(width: 6),
            Text(
              'Conexión Segura',
              style: AppTextStyles.body.copyWith(
                color: AppColors.textSecondary,
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
            ),
          ],
        ),
      ],
    );
  }

  void _login(AuthViewModel authViewModel) async {
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();

    if (email.isEmpty || password.isEmpty) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(Messages.campoRequerido),
          backgroundColor: AppColors.error,
        ),
      );
      return;
    }

    final success = await authViewModel.signIn(email, password);
    
    if (success && context.mounted) {
      // La navegación se maneja automáticamente por AuthWrapper
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Bienvenido/a ${authViewModel.currentUser?.nombre}'),
          backgroundColor: AppColors.success,
        ),
      );
    }
  }

  void _showForgotPasswordDialog() {
    final emailController = TextEditingController();
    
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: Text('Recuperar Contraseña'),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            Text('Ingresa tu correo electrónico para restablecer tu contraseña:'),
            SizedBox(height: AppSpacing.medium),
            TextField(
              controller: emailController,
              decoration: InputDecoration(
                labelText: 'Correo Electrónico',
                border: OutlineInputBorder(),
              ),
            ),
          ],
        ),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: Text('Cancelar'),
          ),
          ElevatedButton(
            onPressed: () async {
              final email = emailController.text.trim();
              if (email.isNotEmpty) {
                Navigator.pop(context);
                final authViewModel = Provider.of<AuthViewModel>(context, listen: false);
                await authViewModel.resetPassword(email);
                
                if (context.mounted) {
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text('Se ha enviado un enlace de recuperación a $email'),
                      backgroundColor: AppColors.success,
                    ),
                  );
                }
              }
            },
            child: Text('Enviar'),
          ),
        ],
      ),
    );
  }
}


// services/auth_service.dart - CORREGIDO
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../models/usuario_model.dart';

class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // OBJETIVO 1: Sistema de autenticación seguro con roles
  Future<Usuario?> signInWithEmailPassword(String email, String password) async {
    try {
      // 1. Autenticar con Firebase Auth
      UserCredential result = await _auth.signInWithEmailAndPassword(
        email: email.trim(),
        password: password,
      );

      // 2. Obtener datos del usuario desde Firestore
      Usuario? usuario = await _getUserData(result.user!.uid);

      if (usuario != null) {
        // 3. Verificar que el usuario esté activo
        if (!usuario.estaActivo) {
          await _auth.signOut();
          throw Exception('Usuario desactivado. Contacte al administrador.');
        }

        // 4. Actualizar último acceso
        await _updateLastAccess(usuario.id);

        return usuario;
      } else {
        await _auth.signOut();
        throw Exception('Usuario no encontrado en el sistema.');
      }
    } on FirebaseAuthException catch (e) {
      throw _handleAuthError(e);
    } catch (e) {
      rethrow;
    }
  }

  Future<Usuario?> _getUserData(String uid) async {
    try {
      DocumentSnapshot doc = await _firestore
          .collection('usuarios')
          .doc(uid)
          .get();
          
      if (doc.exists) {
        return Usuario.fromFirestore(doc);
      }
      return null;
    } catch (e) {
      throw Exception('Error al obtener datos del usuario: $e');
    }
  }

  Future<void> _updateLastAccess(String uid) async {
    try {
      await _firestore.collection('usuarios').doc(uid).update({
        'ultimoAcceso': FieldValue.serverTimestamp(),
      });
    } catch (e) {
      print('Error actualizando último acceso: $e');
    }
  }

  // Manejo de errores de autenticación
  String _handleAuthError(FirebaseAuthException e) {
    switch (e.code) {
      case 'user-not-found':
        return 'No existe una cuenta con este correo electrónico.';
      case 'wrong-password':
        return 'Contraseña incorrecta.';
      case 'invalid-email':
        return 'El formato del correo electrónico es inválido.';
      case 'user-disabled':
        return 'Esta cuenta ha sido desactivada.';
      case 'too-many-requests':
        return 'Demasiados intentos fallidos. Intente más tarde.';
      case 'network-request-failed':
        return 'Error de conexión. Verifique su internet.';
      default:
        return 'Error de autenticación: ${e.message}';
    }
  }

  // Registrar nuevo usuario (solo para administradores)
  Future<Usuario> registerUser({
    required String email,
    required String password,
    required String nombre,
    required String role,
    required String carnet,
    String? departamento,
    String? carrera,
    String? telefono,
  }) async {
    try {
      // 1. Crear usuario en Firebase Auth
      UserCredential userCredential = await _auth.createUserWithEmailAndPassword(
        email: email.trim(),
        password: password,
      );

      // 2. Crear documento en Firestore
      final usuario = Usuario(
        id: userCredential.user!.uid,
        username: email.split('@').first,
        email: email,
        nombre: nombre,
        role: role,
        carnet: carnet,
        departamento: departamento,
        carrera: carrera,
        telefono: telefono,
        estaActivo: true,
        fechaRegistro: DateTime.now(),
        // ✅ CORREGIDO: Usar el método público
        permisos: Usuario.getDefaultPermissions(role),
      );

      await _firestore
          .collection('usuarios')
          .doc(userCredential.user!.uid)
          .set(usuario.toFirestore());

      return usuario;
    } on FirebaseAuthException catch (e) {
      throw _handleAuthError(e);
    } catch (e) {
      throw Exception('Error al registrar usuario: $e');
    }
  }

  // Cambiar contraseña
  Future<void> changePassword(String currentPassword, String newPassword) async {
    try {
      final user = _auth.currentUser;
      if (user != null) {
        // Reautenticar antes de cambiar contraseña
        final cred = EmailAuthProvider.credential(
          email: user.email!,
          password: currentPassword,
        );
        await user.reauthenticateWithCredential(cred);
        await user.updatePassword(newPassword);
      }
    } on FirebaseAuthException catch (e) {
      throw _handleAuthError(e);
    }
  }

  // Restablecer contraseña
  Future<void> resetPassword(String email) async {
    try {
      await _auth.sendPasswordResetEmail(email: email.trim());
    } on FirebaseAuthException catch (e) {
      throw _handleAuthError(e);
    }
  }

  // Cerrar sesión
  Future<void> signOut() async {
    await _auth.signOut();
  }

  // Stream de cambios de estado de autenticación
  Stream<Usuario?> get userStream => _auth.authStateChanges().asyncMap((user) {
    if (user != null) {
      return _getUserData(user.uid);
    }
    return null;
  });

  // Verificar si el usuario actual tiene un permiso específico
  Future<bool> currentUserHasPermission(String permission) async {
    final user = _auth.currentUser;
    if (user != null) {
      final usuario = await _getUserData(user.uid);
      return usuario?.tienePermiso(permission) ?? false;
    }
    return false;
  }

  // Obtener usuario actual
  Future<Usuario?> getCurrentUser() async {
    final user = _auth.currentUser;
    if (user != null) {
      return await _getUserData(user.uid);
    }
    return null;
  }

  // ✅ NUEVO: Método para crear el usuario SuperAdmin inicial
  Future<void> createInitialSuperAdmin() async {
    try {
      // Verificar si ya existe un SuperAdmin
      final superAdminSnapshot = await _firestore
          .collection('usuarios')
          .where('role', isEqualTo: 'SuperAdmin')
          .limit(1)
          .get();

      if (superAdminSnapshot.docs.isEmpty) {
        // Crear el SuperAdmin inicial (Tú)
        await registerUser(
          email: 'colquepachacuti@gmail.com', // Cambia por tu email
          password: 'Admin123!', // Cambia por una contraseña segura
          nombre: 'Nicole Wara Colque Pachacuti',
          role: 'SuperAdmin',
          carnet: '75205630',
          departamento: 'Sistemas Informáticos',
          telefono: '+59175205630',
        );
        print('✅ SuperAdmin creado exitosamente');
      } else {
        print('ℹ️ SuperAdmin ya existe en el sistema');
      }
    } catch (e) {
      print('❌ Error creando SuperAdmin: $e');
    }
  }
}


// models/usuario_model.dart - COMPLETAMENTE CORREGIDO
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:flutter/material.dart';

class Usuario {
  final String id;
  final String username;
  final String email;
  final String nombre;
  final String role;
  final String carnet;
  final String? departamento;
  final String? carrera;
  final String? telefono;
  final bool estaActivo;
  final DateTime fechaRegistro;
  final DateTime? ultimoAcceso;
  final List<String> permisos;

  Usuario({
    required this.id,
    required this.username,
    required this.email,
    required this.nombre,
    required this.role,
    required this.carnet,
    this.departamento,
    this.carrera,
    this.telefono,
    required this.estaActivo,
    required this.fechaRegistro,
    this.ultimoAcceso,
    required this.permisos,
  });

  // Factory desde Firestore
  factory Usuario.fromFirestore(DocumentSnapshot doc) {
    final data = doc.data() as Map<String, dynamic>;
    return Usuario(
      id: doc.id,
      username: data['username'] ?? '',
      email: data['email'] ?? '',
      nombre: data['nombre'] ?? '',
      role: data['role'] ?? 'Estudiante',
      carnet: data['carnet'] ?? '',
      departamento: data['departamento'],
      carrera: data['carrera'],
      telefono: data['telefono'],
      estaActivo: data['estaActivo'] ?? true,
      fechaRegistro: (data['fechaRegistro'] as Timestamp?)?.toDate() ?? DateTime.now(),
      ultimoAcceso: (data['ultimoAcceso'] as Timestamp?)?.toDate(),
      // ✅ CORREGIDO: Usar el método público
      permisos: List<String>.from(data['permisos'] ?? getDefaultPermissions(data['role'] ?? 'Estudiante')),
    );
  }

  // ✅ CORREGIDO: Método público para obtener permisos por defecto
  static List<String> getDefaultPermissions(String role) {
    switch (role) {
      case 'SuperAdmin':
        return [
          'gestion_usuarios',
          'gestion_docentes', 
          'gestion_estudiantes',
          'gestion_cursos',
          'ver_reportes',
          'exportar_datos',
          'configuracion_sistema'
        ];
      case 'Administrador':
        return [
          'gestion_docentes',
          'gestion_estudiantes', 
          'gestion_cursos',
          'ver_reportes',
          'exportar_datos'
        ];
      case 'DirectorAcademico':
        return [
          'gestion_docentes',
          'gestion_cursos',
          'ver_reportes', 
          'exportar_datos'
        ];
      case 'JefeCarrera':
        return [
          'gestion_estudiantes',
          'gestion_cursos',
          'ver_reportes'
        ];
      case 'Docente':
        return [
          'registrar_asistencia',
          'ver_estudiantes',
          'ver_reportes'
        ];
      case 'Secretaria':
        return [
          'gestion_estudiantes',
          'ver_reportes'
        ];
      case 'Estudiante':
        return ['ver_asistencia', 'ver_calificaciones'];
      default:
        return ['ver_asistencia'];
    }
  }

  // Método para verificar permisos
  bool tienePermiso(String permiso) {
    return permisos.contains(permiso);
  }

  // Método para obtener color según rol
  Color get colorRol {
    switch (role) {
      case 'SuperAdmin':
        return const Color(0xFFD32F2F); // Rojo
      case 'Administrador':
        return const Color(0xFF1976D2); // Azul
      case 'DirectorAcademico':
        return const Color(0xFF388E3C); // Verde
      case 'JefeCarrera':
        return const Color(0xFFF57C00); // Naranja
      case 'Docente':
        return const Color(0xFF7B1FA2); // Púrpura
      case 'Secretaria':
        return const Color(0xFF0097A7); // Cyan
      case 'Estudiante':
        return const Color(0xFF00796B); // Verde azulado
      default:
        return const Color(0xFF757575); // Gris
    }
  }

  // Método para obtener ícono según rol
  IconData get iconoRol {
    switch (role) {
      case 'SuperAdmin':
        return Icons.security;
      case 'Administrador':
        return Icons.admin_panel_settings;
      case 'DirectorAcademico':
        return Icons.school;
      case 'JefeCarrera':
        return Icons.engineering;
      case 'Docente':
        return Icons.person;
      case 'Secretaria':
        return Icons.assignment_ind;
      case 'Estudiante':
        return Icons.school;
      default:
        return Icons.person;
    }
  }

  // Convertir a Map para Firestore
  Map<String, dynamic> toFirestore() {
    return {
      'username': username,
      'email': email,
      'nombre': nombre,
      'role': role,
      'carnet': carnet,
      'departamento': departamento,
      'carrera': carrera,
      'telefono': telefono,
      'estaActivo': estaActivo,
      'fechaRegistro': Timestamp.fromDate(fechaRegistro),
      'ultimoAcceso': ultimoAcceso != null ? Timestamp.fromDate(ultimoAcceso!) : null,
      'permisos': permisos,
    };
  }

  // Método para crear un usuario de prueba (opcional)
  factory Usuario.demo({
    required String username,
    required String email,
    required String nombre,
    required String role,
    required String carnet,
    String? departamento,
    String? carrera,
    String? telefono,
  }) {
    return Usuario(
      id: username,
      username: username,
      email: email,
      nombre: nombre,
      role: role,
      carnet: carnet,
      departamento: departamento,
      carrera: carrera,
      telefono: telefono,
      estaActivo: true,
      fechaRegistro: DateTime.now(),
      permisos: getDefaultPermissions(role),
    );
  }

  // Método copyWith para actualizar propiedades
  Usuario copyWith({
    String? id,
    String? username,
    String? email,
    String? nombre,
    String? role,
    String? carnet,
    String? departamento,
    String? carrera,
    String? telefono,
    bool? estaActivo,
    DateTime? fechaRegistro,
    DateTime? ultimoAcceso,
    List<String>? permisos,
  }) {
    return Usuario(
      id: id ?? this.id,
      username: username ?? this.username,
      email: email ?? this.email,
      nombre: nombre ?? this.nombre,
      role: role ?? this.role,
      carnet: carnet ?? this.carnet,
      departamento: departamento ?? this.departamento,
      carrera: carrera ?? this.carrera,
      telefono: telefono ?? this.telefono,
      estaActivo: estaActivo ?? this.estaActivo,
      fechaRegistro: fechaRegistro ?? this.fechaRegistro,
      ultimoAcceso: ultimoAcceso ?? this.ultimoAcceso,
      permisos: permisos ?? this.permisos,
    );
  }

  @override
  String toString() {
    return 'Usuario($id: $nombre - $role)';
  }
}



// viewmodels/auth_viewmodel.dart
import 'package:flutter/material.dart';
import '../services/auth_service.dart';
import '../models/usuario_model.dart';

class AuthViewModel with ChangeNotifier {
  final AuthService _authService;

  Usuario? _currentUser;
  bool _isLoading = false;
  String? _error;

  AuthViewModel(this._authService);

  // Getters
  Usuario? get currentUser => _currentUser;
  bool get isLoading => _isLoading;
  String? get error => _error;
  bool get isAuthenticated => _currentUser != null;

  // Inicializar usuario actual
  Future<void> initialize() async {
    _isLoading = true;
    notifyListeners();

    try {
      _currentUser = await _authService.getCurrentUser();
      _error = null;
    } catch (e) {
      _error = 'Error al inicializar sesión: $e';
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Iniciar sesión
  Future<bool> signIn(String email, String password) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      _currentUser = await _authService.signInWithEmailPassword(email, password);
      _error = null;
      return true;
    } catch (e) {
      _error = e.toString();
      _currentUser = null;
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Cerrar sesión
  Future<void> signOut() async {
    _isLoading = true;
    notifyListeners();

    try {
      await _authService.signOut();
      _currentUser = null;
      _error = null;
    } catch (e) {
      _error = 'Error al cerrar sesión: $e';
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Cambiar contraseña
  Future<bool> changePassword(String currentPassword, String newPassword) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _authService.changePassword(currentPassword, newPassword);
      _error = null;
      return true;
    } catch (e) {
      _error = e.toString();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Restablecer contraseña
  Future<bool> resetPassword(String email) async {
    _isLoading = true;
    _error = null;
    notifyListeners();

    try {
      await _authService.resetPassword(email);
      _error = null;
      return true;
    } catch (e) {
      _error = e.toString();
      return false;
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  // Verificar permisos
  Future<bool> hasPermission(String permission) async {
    return await _authService.currentUserHasPermission(permission);
  }

  // Limpiar error
  void clearError() {
    _error = null;
    notifyListeners();
  }
}


// services/auth_service.dart
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import '../models/usuario_model.dart';

class AuthService {
  final FirebaseAuth _auth = FirebaseAuth.instance;
  final FirebaseFirestore _firestore = FirebaseFirestore.instance;

  // OBJETIVO 1: Sistema de autenticación
  Future<Usuario?> signInWithEmailPassword(
    String email,
    String password,
  ) async {
    try {
      UserCredential result = await _auth.signInWithEmailAndPassword(
        email: email,
        password: password,
      );

      return await _getUserData(result.user!.uid);
    } catch (e) {
      print('Error en login: $e');
      return null;
    }
  }

  Future<Usuario?> _getUserData(String uid) async {
    DocumentSnapshot doc = await _firestore
        .collection('usuarios')
        .doc(uid)
        .get();
    if (doc.exists) {
      return Usuario(
        id: uid,
        username: doc['username'],
        email: doc['email'],
        nombre: doc['nombre'],
        role: doc['role'],
        carnet: doc['carnet'],
        departamento: doc['departamento'],
        estaActivo: doc['estaActivo'],
        fechaRegistro: doc['fechaRegistro'].toDate(),
      );
    }
    return null;
  }

  Stream<Usuario?> get userStream => _auth.authStateChanges().asyncMap((user) {
    if (user != null) return _getUserData(user.uid);
    return null;
  });

  Future<void> signOut() async => await _auth.signOut();
}

// main.dart - ACTUALIZADO
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart';

// Repository
import 'repositories/data_repository.dart';

// Services
import 'services/auth_service.dart';
import 'services/theme_service.dart';

// ViewModels
import 'viewmodels/auth_viewmodel.dart';
import 'viewmodels/dashboard_viewmodel.dart' as dashboard_vm;
import 'viewmodels/carreras_viewmodel.dart';
import 'viewmodels/configuracion_viewmodel.dart';
import 'viewmodels/estudiantes_viewmodel.dart';
import 'viewmodels/paralelos_viewmodel.dart';
import 'viewmodels/docente_viewmodel.dart';
import 'viewmodels/materia_viewmodel.dart';

// Views
import 'views/dashboard/dashboard_screen.dart';
import 'views/dashboard/login_screen.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  try {
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );
  } catch (e) {
    debugPrint('⚠ Error al inicializar Firebase: $e');
  }

  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        // Services
        Provider<AuthService>(create: (_) => AuthService()),
        Provider<DataRepository>(create: (_) => DataRepository()),
        
        // Theme
        ChangeNotifierProvider<ThemeService>(
          create: (_) => ThemeService()..loadThemePreference(),
        ),
        
        // Auth
        ChangeNotifierProvider<AuthViewModel>(
          create: (context) => AuthViewModel(
            Provider.of<AuthService>(context, listen: false),
          )..initialize(),
        ),

        // Other ViewModels
        ChangeNotifierProvider<dashboard_vm.DashboardViewModel>(
          create: (context) => dashboard_vm.DashboardViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<CarrerasViewModel>(
          create: (context) => CarrerasViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<ConfiguracionViewModel>(
          create: (context) => ConfiguracionViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<ParalelosViewModel>(
          create: (context) => ParalelosViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<EstudiantesViewModel>(
          create: (context) => EstudiantesViewModel(
            tipo: '',
            carrera: {},
            turno: {},
            nivel: {},
            paralelo: {},
            repository: Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<DocentesViewModel>(
          create: (context) => DocentesViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
        ChangeNotifierProvider<MateriaViewModel>(
          create: (context) => MateriaViewModel(
            Provider.of<DataRepository>(context, listen: false),
          ),
        ),
      ],
      child: Consumer<ThemeService>(
        builder: (context, themeService, child) {
          return MaterialApp(
            debugShowCheckedModeBanner: false,
            title: 'Incos App',
            theme: _buildLightTheme(),
            darkTheme: _buildDarkTheme(),
            themeMode: themeService.themeMode,
            home: const AuthWrapper(),
          );
        },
      ),
    );
  }

  ThemeData _buildLightTheme() => ThemeData(
    primarySwatch: Colors.blue,
    scaffoldBackgroundColor: Colors.grey[100],
    appBarTheme: const AppBarTheme(
      backgroundColor: Colors.blueAccent,
      elevation: 0,
      centerTitle: true,
      titleTextStyle: TextStyle(
        fontSize: 20,
        fontWeight: FontWeight.bold,
        color: Colors.white,
      ),
    ),
    bottomNavigationBarTheme: const BottomNavigationBarThemeData(
      selectedItemColor: Colors.blueAccent,
      unselectedItemColor: Colors.grey,
      showUnselectedLabels: true,
      type: BottomNavigationBarType.fixed,
    ),
  );

  ThemeData _buildDarkTheme() => ThemeData(
    primarySwatch: Colors.blue,
    scaffoldBackgroundColor: const Color(0xFF121212),
    appBarTheme: const AppBarTheme(
      backgroundColor: Colors.blueAccent,
      elevation: 0,
      centerTitle: true,
      titleTextStyle: TextStyle(
        fontSize: 20,
        fontWeight: FontWeight.bold,
        color: Colors.white,
      ),
    ),
    bottomNavigationBarTheme: const BottomNavigationBarThemeData(
      selectedItemColor: Colors.blueAccent,
      unselectedItemColor: Colors.grey,
      showUnselectedLabels: true,
      type: BottomNavigationBarType.fixed,
      backgroundColor: Color(0xFF121212),
    ),
  );
}

class AuthWrapper extends StatelessWidget {
  const AuthWrapper({super.key});

  @override
  Widget build(BuildContext context) {
    final authViewModel = Provider.of<AuthViewModel>(context);

    if (authViewModel.isLoading) {
      return const Scaffold(
        body: Center(
          child: CircularProgressIndicator(),
        ),
      );
    }

    if (authViewModel.isAuthenticated) {
      return const DashboardScreen();
    } else {
      return const LoginScreen();
    }
  }
}